#!/bin/bash

###############################################################################
# Nimble Node - Wallet Creation Script
# 
# This script creates a new Lightning Network wallet for your Nimble Node.
# It will prompt you to set up:
# - Wallet encryption password (minimum 8 characters)
# - Seed phrase generation or import
#
# IMPORTANT: Back up your seed phrase and encryption password securely!
# Without these, you cannot recover your funds if something goes wrong.
###############################################################################

set -e  # Exit immediately if a command exits with a non-zero status

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Function to print colored messages
print_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_step() {
    echo -e "${CYAN}[STEP]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

###############################################################################
# Step 1: Verify root privileges
###############################################################################
print_step "Checking root privileges..."

if [ "$EUID" -ne 0 ]; then 
    print_error "This script must be run as root"
    print_info "Please run: sudo $0"
    exit 1
fi

print_success "Root privileges verified"
echo ""

###############################################################################
# Step 2: Check if Docker is running
###############################################################################
print_step "Checking Docker status..."

if ! systemctl is-active --quiet docker; then
    print_error "Docker is not running"
    print_info "Please start Docker with: systemctl start docker"
    exit 1
fi

print_success "Docker is running"
echo ""

###############################################################################
# Step 3: Check if the 'lit' container exists
###############################################################################
print_step "Checking if 'lit' container exists..."

if ! docker ps -a --format '{{.Names}}' | grep -q '^lit$'; then
    print_error "Container 'lit' not found"
    print_info "Please ensure docker compose has been started:"
    print_info "  $ docker compose up -d"
    exit 1
fi

print_success "Container 'lit' found"
echo ""

###############################################################################
# Step 4: Check if the container is running
###############################################################################
print_step "Checking if 'lit' container is running..."

if ! docker ps --format '{{.Names}}' | grep -q '^lit$'; then
    print_warning "Container 'lit' is not running"
    print_info "Starting the container..."
    
    if docker start lit; then
        print_success "Container started successfully"
        # Wait a moment for the container to fully start
        sleep 2
    else
        print_error "Failed to start the container"
        exit 1
    fi
else
    print_success "Container 'lit' is running"
fi
echo ""

###############################################################################
# Step 5: Display important information before creating wallet
###############################################################################
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}                WALLET CREATION PROCESS                  ${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
print_warning "You are about to create a new Lightning Network wallet"
echo ""
echo "During this process you will need to:"
echo "  1. Choose a wallet encryption password (min 8 characters)"
echo "  2. Generate a new seed phrase OR import an existing one"
echo "  3. Optionally set a cipher seed passphrase for additional security"
echo ""
print_warning "CRITICAL: Write down and safely store your seed phrase!"
echo ""
echo "Without your seed phrase and encryption password, you CANNOT"
echo "recover your funds if something goes wrong with your node."
echo ""
read -p "Press ENTER to continue or Ctrl+C to cancel..."
echo ""

###############################################################################
# Step 6: Create the wallet
###############################################################################
print_step "Starting wallet creation process..."
echo ""
print_info "Connecting to Lightning Terminal (lit) container..."
echo ""

# Execute the wallet creation command
if docker exec -ti lit /app/lncli create; then
    echo ""
    print_success "Wallet creation command completed"
else
    echo ""
    print_error "Wallet creation failed"
    print_info "Please check the error messages above"
    exit 1
fi

echo ""

###############################################################################
# Step 7: Fix permissions on wallet files
###############################################################################
print_step "Fixing file permissions..."

LND_DATA_DIR=".lnd/data/chain/bitcoin/mainnet"

if [ -d "$LND_DATA_DIR" ]; then
    print_info "Setting ownership to dev:dev for $LND_DATA_DIR/*"
    
    if chown -R dev:dev "$LND_DATA_DIR"/*; then
        print_success "Permissions updated successfully"
    else
        print_warning "Failed to update some permissions (this may be normal if some files don't exist yet)"
    fi
else
    print_warning "Directory $LND_DATA_DIR not found yet"
    print_info "This is normal for a fresh installation - permissions will be set on first use"
fi

echo ""

###############################################################################
# Completion message
###############################################################################
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}           WALLET CREATED SUCCESSFULLY!                  ${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
print_info "Next steps:"
echo ""
echo "  1. Wait approximately 20 minutes for initial sync"
echo ""
echo "  2. Access your node via web interface:"
echo "     https://your-domain-name:8443"
echo ""
echo "  3. If you restart the container, unlock your wallet with:"
echo "     $ ./scripts/unlock"
echo ""
echo "  4. (Optional) Initialize Balance of Satoshis:"
echo "     $ ./scripts/initbos"
echo ""
print_warning "Remember: Keep your seed phrase and password in a safe place!"
print_warning "         Never share them with anyone!"
echo ""
